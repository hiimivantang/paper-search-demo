## Codebase Patterns
- Collection name is `semantic_scholar_papers` — used across all api/ files and scripts
- Python API functions use lazy-loaded singleton MilvusClient with `MILVUS_URI` and `MILVUS_TOKEN` env vars
- MILVUS_URI env var needs `.strip()` due to whitespace issues in Vercel
- Vercel serverless functions use `BaseHTTPRequestHandler` pattern in `api/` directory
- Frontend is a single `app/page.tsx` client component with React hooks for all state
- Existing fields: vector (dense), title_sparse (sparse/BM25), title (varchar), year (int), citationcount (int), corpusid (int), url (varchar)
- pymilvus MilvusClient.list_indexes(collection_name, field_name=) returns list of index name strings
- pymilvus MilvusClient.prepare_index_params() + add_index() + create_index() for creating indexes
- Hybrid search uses `AnnSearchRequest` + `client.hybrid_search()` with `RRFRanker()` for fusing dense+sparse results
- `search_mode` parameter in request body controls search mode: 'semantic', 'keyword', 'hybrid'
- Backward compat: when `search_mode` is not set, infer from `highlight_mode` (lexical → keyword, else → semantic)
- Boost Ranker (v2.6) uses `use_boost_ranker` param — adds FunctionScore boost for semantic/keyword, post-processing for hybrid
- `hybrid_search()` only supports RRFRanker/WeightedRanker — for custom boosting in hybrid mode, apply post-processing on results
- Autocomplete min char length is in TWO places: `api/autocomplete.py` (backend) and `app/page.tsx` (frontend) — update both when changing
- Layout: header is `max-w-6xl`, main content is `max-w-6xl` with two-column flex (sidebar + main area)
- Filter sidebar: left `<aside>` with `w-full md:w-64 flex-shrink-0`, `bg-gray-50 rounded-lg` container
- Milvus `filter` parameter: pass filter expression string to `client.search()` or `client.hybrid_search()` — works with all search modes
- Filter chips: use `useEffect` with ref tracking to auto-re-search when filters change (similar to searchMode pattern)
- Settings popover: gear icon button next to search mode switcher, `settingsRef` + click-outside handler for close-on-blur
- `useBoostRanker` state sends `use_boost_ranker` param to API — separate from `useBoost` (Citation Boost)
- Theme colors: white bg, slate-700 (#334155) text, blue-600 (#2563EB) primary, slate-200 (#E2E8F0) borders
- Removed: gradient-text class, dark header gradient, glassmorphism/backdrop-blur effects on search input
- Search mode switcher: `searchMode` state (`SearchMode` type) with `handleSearchModeChange` callback + useEffect for auto-re-search on mode change
- Mode switcher UI is a segmented control (pill toggle) with `bg-slate-100` container + `bg-blue-600` active state, placed between header title and search input
- To trigger search after setting query from a UI action (e.g., suggested query click), use `pendingSuggestedSearch` ref + `useEffect` on `query` — avoids stale state from batched `setQuery`

---

## 2026-02-12 - US-001
- What was implemented: Created `scripts/setup_indexes.py` — an idempotent Python script that adds an NGRAM index on the `title` field with min_gram=2, max_gram=3
- Files changed: `scripts/setup_indexes.py` (new)
- **Learnings for future iterations:**
  - NGRAM index creation uses `prepare_index_params()` → `add_index(field_name, index_type="NGRAM", index_name, min_gram, max_gram)` → `create_index(collection_name, index_params)`
  - Use `list_indexes(collection_name, field_name="title")` to check if index already exists before creating
  - The NGRAM index enables fast LIKE substring matching — the existing autocomplete query pattern (`LIKE "%query%"`) works as-is, just faster
  - min_gram=2 means autocomplete can trigger at 2 chars (used in US-004)
---

## 2026-02-12 - US-002
- What was implemented: Added hybrid search mode to `api/search.py` using pymilvus `hybrid_search()` with `AnnSearchRequest` and `RRFRanker`
- Files changed: `api/search.py` (modified), `api/requirements.txt` (bumped pymilvus to >=2.6.0)
- **Learnings for future iterations:**
  - `AnnSearchRequest` takes `data`, `anns_field`, `param` (dict with metric_type for sparse), and `limit`
  - `client.hybrid_search()` takes `reqs` (list of AnnSearchRequest), `ranker` (RRFRanker), `limit`, `output_fields`
  - For BM25 sparse AnnSearchRequest, pass raw text string in data list (not embeddings) and `param={"metric_type": "BM25"}`
  - Existing FunctionScore rankers (time_decay, boost) work with `client.search()` but are NOT passed to `hybrid_search()` — hybrid uses RRFRanker separately
  - The `search_mode` parameter is separate from `highlight_mode` — they are orthogonal concerns
---

## 2026-02-12 - US-003
- What was implemented: Added Boost Ranker integration to `api/search.py` with `use_boost_ranker` request parameter. Recency boost (1.3x) for year >= 2022, citation boost (1.2x) for citationcount >= 500.
- Files changed: `api/search.py` (modified)
- **Learnings for future iterations:**
  - For `semantic` and `keyword` modes, Boost Ranker adds `Function` objects with `FunctionType.RERANK` and `"reranker": "boost"` to the `FunctionScore` — same pattern as existing `use_boost`
  - For `hybrid` mode, `hybrid_search()` only accepts `RRFRanker`/`WeightedRanker`, so boost is applied as post-processing: multiply scores by boost weights then re-sort
  - The boost weights (1.3 for recency, 1.2 for citations) are multiplicative — a paper matching both gets 1.3 * 1.2 = 1.56x boost
  - `use_boost_ranker` is independent from the existing `use_boost` — they can be used together
---

## 2026-02-12 - US-004
- What was implemented: Updated autocomplete to leverage NGRAM index — reduced minimum character threshold from 4 to 2 in both backend (`api/autocomplete.py`) and frontend (`app/page.tsx`). Added docstring explaining NGRAM index fallback behavior.
- Files changed: `api/autocomplete.py` (modified), `app/page.tsx` (modified)
- **Learnings for future iterations:**
  - NGRAM index accelerates existing `LIKE "%query%"` queries transparently — no query pattern change needed
  - The minimum character check exists in two places: backend handler and frontend useEffect — both must be updated in sync
  - The LIKE query works with or without the NGRAM index; the index just makes it faster (graceful fallback)
---

## 2026-02-12 - US-005
- What was implemented: Redesigned base theme and layout shell — replaced dark header gradient with clean white background, updated globals.css with light theme colors (white bg, slate-700 text, blue-600 primary, slate-200 borders), set up two-column layout (narrow sidebar + main content area) using flex with mobile-responsive collapse, updated typography hierarchy (600 headings, 500 labels, 400 body), removed gradient-text/glassmorphism effects
- Files changed: `app/globals.css` (modified), `app/page.tsx` (modified)
- **Learnings for future iterations:**
  - Two-column layout uses `flex flex-col md:flex-row` with sidebar as `w-full md:w-64 flex-shrink-0` — collapses to horizontal on mobile
  - Container widened from `max-w-3xl` to `max-w-6xl` to accommodate sidebar + main content
  - Header is now separate from the layout body — sits above the two-column area with `border-b border-slate-200`
  - Search options panel moved into the sidebar `<aside>` element — will be replaced by settings popover in US-008
  - Removed `gradient-text` CSS class and `backdrop-blur-card` — no longer needed with light theme
  - The empty state icon now uses `bg-blue-50` instead of gradient background
---

## 2026-02-12 - US-006
- What was implemented: Redesigned header and search input — increased header vertical spacing, made search input larger (py-4) with subtle shadow, added animated focus ring via `.search-input` CSS class with 200ms transition on border-color and box-shadow, refined search button (rounded-md, slightly taller), adjusted autocomplete dropdown spacing (mt-1.5, py-2.5, shadow-md), added pointer-events-none on search icon
- Files changed: `app/page.tsx` (modified), `app/globals.css` (modified)
- **Learnings for future iterations:**
  - The `.search-input` CSS class provides animated focus ring (200ms ease transition on border-color + box-shadow) — reuse this pattern for other prominent inputs
  - Adding `pointer-events-none` to icons inside inputs prevents them from intercepting clicks intended for the input
  - Most of the US-006 criteria were already satisfied by US-005's base theme work — focus on incremental refinement
  - Autocomplete dropdown shadow uses `shadow-md` (not `shadow-lg`) for subtlety matching the light theme
---

## 2026-02-12 - US-007
- What was implemented: Added search mode switcher — a segmented control (pill toggle) with Semantic, Keyword, and Hybrid options, placed between header title/subtitle and search input. Hybrid is selected by default. Each mode shows a small subtitle. Switching modes auto-triggers search if a query exists. The `search_mode` parameter is sent in the API request body.
- Files changed: `app/page.tsx` (modified)
- **Learnings for future iterations:**
  - Used `useRef` + `useEffect` pattern to detect `searchMode` changes and auto-trigger `handleSearch()` — avoids infinite loops by tracking previous value in a ref
  - The `SearchMode` type ('semantic' | 'keyword' | 'hybrid') maps directly to the backend `search_mode` parameter values
  - Mode switcher uses `inline-flex` container with `bg-slate-100 rounded-lg p-1` — active mode gets `bg-blue-600 text-white`, inactive gets transparent with `text-slate-600`
  - Each mode button shows a subtitle (`text-[10px]`) that changes color based on active state (blue-100 when active, slate-400 when inactive)
  - `handleSearch` dependency array must include `searchMode` since the request body now includes `search_mode`
---

## 2026-02-12 - US-008
- What was implemented: Refactored sidebar options panel into a settings popover. Replaced the `<aside>` sidebar with a gear icon button next to the search mode switcher. Clicking opens a popover with ranker toggles (Time Decay, Citation Boost, Boost Ranker v2.6), highlighting mode (Off / Keyword Highlights), result limit dropdown (5–50), and advanced time decay settings. Added `useBoostRanker` state that sends `use_boost_ranker=true` to the API. Popover closes on click outside. Below the search bar, a summary line shows active settings (e.g., "10 results · Boost Ranker · Keyword highlights"). Layout simplified from two-column to single-column `max-w-4xl`.
- Files changed: `app/page.tsx` (modified)
- **Learnings for future iterations:**
  - Click-outside handler pattern: `useRef` on popover container + `mousedown` listener added/removed based on `showSettings` state
  - Settings popover is positioned `absolute right-0 top-full mt-2` relative to the gear button — `z-30` ensures it's above autocomplete (`z-20`)
  - Summary line is always visible (not conditional) — shows at minimum "10 results" even with no active options
  - Removed `showOptions` state (sidebar toggle) and `activeOptionsCount`, replaced with `showSettings` and `settingsSummary` array
  - `useBoostRanker` is independent from `useBoost` — they can be combined. Backend already handles both.
  - The sidebar removal means US-010 (faceted filtering) will need to put filters somewhere else — consider bringing back sidebar or using another approach
---

## 2026-02-12 - US-009
- What was implemented: Redesigned result cards with richer metadata. Title is now a clickable link that opens the Semantic Scholar URL in a new tab. Score displayed as a percentage badge (rounded-full pill). Card has shadow-sm by default with shadow-md on hover (200ms transition). Citation count thresholds changed from `>` to `>=` for 1000 and 100. Removed the separate "View" link and the `#idx` / raw score header row — replaced with cleaner title-first layout with percentage badge on the right. Staggered slideUp animation preserved (50ms delay between cards).
- Files changed: `app/page.tsx` (modified)
- **Learnings for future iterations:**
  - Score is a float 0-1 from Milvus — multiply by 100 and round for percentage display
  - Citation count color coding uses `>=` (not `>`) thresholds: emerald-600 for 1000+, blue-600 for 100-999, slate-500 for <100
  - Title is wrapped in an `<a>` tag inside the `<h3>` — keeps heading semantics while making the title clickable
  - The `transition-shadow` utility is more targeted than `transition-all` for card hover effects
---

## 2026-02-12 - US-010
- What was implemented: Added faceted filtering sidebar with Year Range (min/max number inputs) and Citation Count (radio buttons: Any, 10+, 100+, 500+, 1000+). Filters construct a Milvus filter expression string (e.g., `year >= 2020 and citationcount >= 100`) sent as `filter` parameter in the API request. Backend passes filter through to all search modes (semantic, keyword, hybrid). Active filters shown as removable chip badges above results with X to remove individual filters and "Clear all" link. Removing a filter chip auto-re-triggers search. Layout widened back to `max-w-6xl` two-column flex (sidebar + main content).
- Files changed: `api/search.py` (modified — added `filter` parameter passthrough), `app/page.tsx` (modified — added filter state, sidebar UI, chips, two-column layout), `prd.json` (US-010 passes: true)
- **Learnings for future iterations:**
  - Milvus `filter` param works with `client.search()`, `client.hybrid_search()` — just pass the expression string directly
  - For auto-re-search on state change, use `useEffect` + ref to track previous value (same pattern as `searchMode`). Don't call `handleSearch()` directly in onClick since React state updates are batched
  - `hasResultsRef` pattern avoids putting `results` in the effect dependency array which would cause infinite loops (since handleSearch sets results)
  - Filter expression is constructed on the frontend as a simple `and`-joined string of Milvus scalar filter conditions
  - Two-column layout restored: `flex flex-col md:flex-row gap-6` with aside `w-full md:w-64 flex-shrink-0`
---

## 2026-02-12 - US-011
- What was implemented: Replaced the pre-search empty state with a centered onboarding experience: large search icon (slate-300), "Search academic papers" heading, "Try one of these queries:" subtitle, and 5 clickable suggested query pills (transformer attention mechanisms, neural network pruning, large language models, graph neural networks, reinforcement learning robotics). Clicking a pill fills the search input and auto-triggers a search. Updated the zero-results empty state with "No results found" heading and helpful suggestion text ("Try using broader terms, different keywords, or removing some filters"). Both empty states use slate-400 text.
- Files changed: `app/page.tsx` (modified), `prd.json` (US-011 passes: true)
- **Learnings for future iterations:**
  - To trigger search after setting query from a button click, use a `pendingSuggestedSearch` ref + `useEffect` on `query` change — can't call `handleSearch()` directly since `setQuery` is batched and `query` won't be updated yet
  - The suggested query pills use `rounded-full` with `bg-blue-50 border border-blue-200` styling — consistent with filter chip styling
  - Empty states are vertically centered using `py-20` (pre-search) and `py-16` (zero results) within the `<main>` flex area
---

## 2026-02-12 - US-012
- What was implemented: Added v2.6 feature callout badges to four locations: (1) "v2.6" badge on the Hybrid mode button in the search switcher, positioned absolute top-right; (2) "NGRAM Index" badge inside the autocomplete dropdown as a subtle header row; (3) "v2.6 Boost Ranker" badge next to the Boost Ranker label in the settings popover; (4) "Filtered Search" badge next to the Filters heading in the sidebar. Each badge has a title tooltip explaining the feature.
- Files changed: `app/page.tsx` (modified), `prd.json` (US-012 passes: true)
- **Learnings for future iterations:**
  - Badge styling pattern: `rounded-full text-[10px] px-2 py-0.5 bg-blue-50 text-blue-600 font-medium` — consistent across all badge placements
  - For badges on buttons with constrained space (like the mode switcher), use `absolute` positioning with negative offsets (`-top-2 -right-2`) and add `relative` to the parent
  - For badges in list/dropdown contexts (autocomplete), a non-interactive `<li>` row with `flex justify-end` works well as a subtle header badge
  - Each badge uses `title` attribute for tooltip — lightweight, no extra components needed
  - All badges are informational only (no click handlers) — they don't disrupt layout or interactive behavior
---
